# kanoe

 Download entries from https://entries.gbcanoemarathon.co.uk/entries.

 1. Login.
 2. At top/right click on name and then "Newbucy CC Admin".

## App

Running the app:

```
flask --app kanoe run
```

During development you will want to run the app in debug mode:

```
flask --app kanoe --debug run
```

The app will be available on http://127.0.0.1:5000.

## Users

Followed these articles to setup user management:

- https://www.freecodecamp.org/news/how-to-authenticate-users-in-flask/
- https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins

## Database

### Alembic

Using Alembic to create migration scripts.

At present the Alembic migrations are applied to a `kanoe.db` file in the `database/` folder. So you'll need to move the file to that location first.

Commands used:

- `alembic revision -m "..."` — An empty migration (message is optional).
- `alembic revision --autogenerate -m "..."` — Autogenerated from changes to classes (message is optional).
- `alembic upgrade head`
- `alembic current`
- `alembic history`

Alembic produces migrations in Python. We can convert those to SQL.

```bash
OUTPATH=liquibase/changesets/${NEWHASH}
mkdir -p ${OUTPATH}
alembic upgrade ${OLDHASH}:${NEWHASH} --sql >${OUTPATH}/setup.sql
```

### Liquibase

Liquibase used to manage deployment (via CI/CD) of migration scripts.

To prepare the SQL script for Liquibase, annotate it according to the following rules:

1. Begin every script with a `--liquibase formatted sql` line.
2. Stamp the changeset with a `--changeset YOURNAMEHERE:NEWHASH` slug.
3. Use a `--precondition-sql-check` to check the current version.
4. Comment liberally via `--comment: ...`.
5. Whenever possible, follow each statement with a `--rollback: <command>`.

Each changeset needs to be added to the master XML file `db.changelog-root.xml`.

Further documentation can be found [here](https://docs.liquibase.com/concepts/basic/sql-format.html).

## Testing

- https://flask.palletsprojects.com/en/2.2.x/testing/

To run test suite:

```bash
# Run all tests.
pytest
# Run all tests and show console output (useful for debugging).
pytest -s
```

### Coverage

To get a coverage report:

```bash
pytest --cov
```
