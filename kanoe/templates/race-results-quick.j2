{% extends "base.j2" %}

{% block title %}Capture Race Results{% endblock %}

{% block styles %}
{% include 'common/datatables-css.j2' %}
{% endblock %}

{% block content %}

{#
Form workflow:

1. Type race number.
2. Press tab (field with paddler names will be populated and focus will shift to start time field).
3. If the start time is already populated then focus will shift to the finish time field, otherwise enter start time (or leave blank).
4. Press tab (focus will advance to the finish time field).
5. Enter finish time (or leave blank).
6. Press tab (focus will shift to the Submit button).
7. Press Enter to submit.
8. Focus will shift back to the race number field. Repeat.

You can also press enter in either the start time or finish time field to submit the form.
#}

<h1>Capture Race Results</h1>  

<form method="post">
    <input type="hidden" id="entry_id" name="entry_id">
    <div class="row">
        <div class="col-md-6">
            <div class="row">
                <label for="title" class="col-sm-4 col-form-label">Race Number</label>
                <div class="col-sm-8">
                    <input type="number"
                           class="form-control"
                           id="race_number"
                           placeholder="Race Number"
                           autofocus>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row">
                <input type="text"
                       class="form-control"
                       id="paddlers"
                       name="paddlers"
                       placeholder="Paddlers"
                       disabled
                       readonly
                       tabindex="-1">
            </div>
        </div>
        <div class="col">
            <div class="row">
                <label for="start" class="col-sm-4 col-form-label">Start time</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control time" id="time_start" name="time_start">
                </div>
            </div>
            <div class="row">
                <label for="finish" class="col-sm-4 mt-1 col-form-label">Finish time</label>
                <div class="col-sm-8 mt-1">
                    <input type="text" class="form-control time" id="time_finish" name="time_finish">
                </div>
            </div>
        </div>
        <div class="col">
            <div class="row mt-2">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="1" tabindex="-1" id="retired" name="retired">
                        <label class="form-check-label" for="retired">Retired</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="1" tabindex="-1" id="disqualified" name="disqualified">
                        <label class="form-check-label" for="disqualified">Disqualified</label>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-4">
        <button type="submit" class="btn btn-primary" id="submit">Submit</button>
    </div>
</form>

{% endblock %}

{% block scripts %}
{% include 'common/jquery-javascript.j2' %}
{% include 'common/datatables-javascript.j2' %}
<script type="text/javascript" class="init">
$(document).ready(function () {
    // Flashed messages disappear after a short delay.
    setTimeout(function() {
        $('.alert').fadeOut('slow');
    }, 2000);

    // Populate the Paddler(s) field based on chosen race number.
    var select_race_number = function() {
        if ($(this).val() === "") {
            console.log("No race number specified.");
            $('#paddlers').val("");
            $('#entry_id').removeAttr("value");
            $('#time_start').val("");
            $('#time_finish').val("");
        } else {
            $.ajax({
                url: "/api/get-entry",
                type: "post",
                data: { race_id: {{ race_id }}, race_number: $(this).val() },
                success: function(response) {
                    $('#paddlers').val(response["paddlers"]);
                    $('#entry_id').val(response["entry_id"]);
                    $('#time_start').val(response["time_start"]);
                    $('#time_finish').val(response["time_finish"]);
                    if (response["time_start"] != null) {
                        $('#time_finish').focus();
                        if (response["time_finish"] != null) {
                            $('#submit').focus();
                        }
                    }
                }
            });
        }
    };

    $("#race_number").focusout(select_race_number);
    $("#race_number").keypress(function(event) {
        if (event.key == "Enter") {
            // Don't submit form when press Enter on Race Number field.
            event.preventDefault();
            select_race_number.apply(this)
        }
    });

    $('.time').focus(function() {
        $(this).select();
    });
});
</script>
{% endblock %}